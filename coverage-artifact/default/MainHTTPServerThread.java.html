<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainHTTPServerThread.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pa-web-server</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">MainHTTPServerThread.java</span></div><h1>MainHTTPServerThread.java</h1><pre class="source lang-java linenums">import java.io.*;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.Semaphore;

/**
 * The MainHTTPServerThread class implements the core HTTP server that listens on a specified port.
 * &lt;p&gt;
 * This thread handles incoming HTTP requests, manages concurrent connections using
 * a configured thread pool and enforces requests limits through a semaphore. It
 * coordinates with other components to serve files securely
 * and maintain request logs in JSON format.
 */

public class MainHTTPServerThread extends Thread {

    private final ServerConfig config;
    private final ThreadPool threadPool;
    private final FileAccessController fileAccessController;
    private BlockingQueue&lt;LogEntry&gt; logQueue;
    private final Semaphore requestLimiter;

    /**
     * Constructs a new MainHTTPServerThreads with the specified configuration,
     * thread pool, file access controller, log queue, and request limiter.
     *
     * @param config The server configuration containing settings such as port and root directories.
     * @param threadPool The thread pool used to handle client requests.
     * @param fileAccessController The controller managing file access permissions.
     * @param logQueue The queue for logging server activities.
     * @param requestLimiter The semaphore to limit the number of concurrent requests limit.
     */

<span class="fc" id="L35">    public MainHTTPServerThread(ServerConfig config, ThreadPool threadPool, FileAccessController fileAccessController, BlockingQueue&lt;LogEntry&gt; logQueue, Semaphore requestLimiter) {</span>
<span class="fc" id="L36">        this.config = config;</span>
<span class="fc" id="L37">        this.threadPool = threadPool;</span>
<span class="fc" id="L38">        this.fileAccessController = fileAccessController;</span>
<span class="fc" id="L39">        this.logQueue = logQueue;</span>
<span class="fc" id="L40">        this.requestLimiter = requestLimiter;</span>
<span class="fc" id="L41">    }</span>

    /**
     * Starts the HTTP server and listens for incoming client requests.
     * Processes HTTP GET requests and serves files from the defined server root directory.
     * &lt;p&gt;
     * The server runs indefinitely until interrupted, performing the following operarions:
     * 1. Listen on the configured port for incoming connections
     * 2. Acquire a permit from the semaphore for each new request
     * 3. Delegates request processing to the thread pool
     * 4. Releases the semaphore permit when processing completes
     * &lt;/p&gt;
     * &lt;p&gt;
     * On interruption or IO error, the server shuts down by:
     * 1. Interrupting the current thread
     * 2. Shutting down the thread pool
     * 3. Closing all resources
     * &lt;/p&gt;
     *
     */

    @Override
    public void run() {
        try {
<span class="fc" id="L65">            ServerSocket server = new ServerSocket(config.getIntConfig(&quot;server.port&quot;));</span>
<span class="fc" id="L66">            System.out.println(&quot;Server started on port: &quot; + config.getIntConfig(&quot;server.port&quot;));</span>
<span class="fc" id="L67">            System.out.println(&quot;Server Root: &quot; + config.getConfig(&quot;server.root&quot;));</span>
<span class="fc" id="L68">            System.out.println(&quot;Document Root: &quot; + config.getConfig(&quot;server.document.root&quot;));</span>

            while (true) {
<span class="fc" id="L71">                Socket client = server.accept();</span>
<span class="fc" id="L72">                requestLimiter.acquire();</span>

<span class="fc" id="L74">                threadPool.execute(() -&gt; {</span>
                    try {
<span class="fc" id="L76">                        new ClientHandler(client, config, fileAccessController, logQueue).run();</span>
                    } finally {
<span class="fc" id="L78">                        requestLimiter.release();</span>
                    }
<span class="fc" id="L80">                });</span>
<span class="fc" id="L81">            }</span>
<span class="nc" id="L82">        } catch (IOException | InterruptedException e) {</span>
<span class="nc" id="L83">            Thread.currentThread().interrupt();</span>
        } finally {
<span class="nc" id="L85">            threadPool.shutdown();</span>
        }
<span class="nc" id="L87">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>